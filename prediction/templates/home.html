<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>æ±äº¬ ã‚¯ãƒå‡ºæ²¡äºˆæ¸¬</title>
  <style>
    #map { height: 400px; width: 50%; }
    label { font-weight: bold; }
  </style>
</head>
<body>
  
  <div style="background: linear-gradient(90deg, #f6d365 0%, #fda085 100%); color: #333; font-size: 1.5em; font-weight: bold; text-align: center; padding: 0.5em; border-radius: 10px; margin-bottom: 1em; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 3px solid #fda085;">
    æ±äº¬ ã‚¯ãƒå‡ºæ²¡äºˆæ¸¬
  </div>
  <div style="background: #fffbe9; color: #d35400; font-size: 0.8em; font-weight: bold; text-align: left; padding: 0.7em 1em; border-radius: 8px; margin-bottom: 1.2em; border: 2px dashed #fda085; box-shadow: 0 1px 6px rgba(253,160,133,0.08); letter-spacing: 0.03em;">
    <span style="font-size:1.5em; vertical-align:middle; margin-right:0.3em;">ğŸ—ºï¸</span>
    ãƒãƒƒãƒ—ä¸Šã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€äºˆæ¸¬ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ã¦ãã ã•ã„<br>
    <span style="font-size:0.85em; color:#a67c52; font-weight:normal;">â€»æ±äº¬ã€åŸ¼ç‰ã€å±±æ¢¨ä»¥å¤–ã®åœ°ç‚¹ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’æŒã£ã¦ã„ãªã„ãŸã‚äºˆæ¸¬ã§ãã¾ã›ã‚“</span>
  </div><div style="font-size:0.75em; color:#888; text-align:right; margin-bottom:1em;">
  â€» æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã®åˆ©ç”¨ã«é–¢ã™ã‚‹æ³¨æ„äº‹é …ã¯
  <a href="{% url 'disclaimer' %}">å…è²¬äº‹é …</a>ã‚’ã”ç¢ºèªãã ã•ã„
</div>

  <div style="display: flex; align-items: flex-start; gap: 2em;">
    <div id="map" style="height: 400px; width: 50%; min-width: 320px;"></div>
    <form method="post" enctype="multipart/form-data" style="flex: 1; min-width: 250px; max-width: 350px; background: #fffbe9; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 1em; border: 1.5px solid #fda085;">
      {% csrf_token %}
      <div style="display: flex; flex-direction: column; gap: 0.7em;">
        {% if predict_result %}
          äºˆæ¸¬çµæœ:1.0ä»¥ä¸Šã§å‡ºæ²¡å¯èƒ½æ€§é«˜
          <div style="margin: 1em 0; padding: 0.7em; background: #eafaf1; color: #1a7f37; border-radius: 6px; font-weight: bold; text-align: center; border: 1.5px solid #1a7f37;">
            äºˆæ¸¬çµæœ: {{ predict_result }}
          </div>
        {% endif %}
        <label for="id_lat">ç·¯åº¦ (lat)</label>
        {{ form.lat }}
        <label for="id_lon">çµŒåº¦ (lon)</label>
        {{ form.lon }}
        <label for="id_address">ä½æ‰€ (address)</label>
        {{ form.address }}
        <label for="id_place_name">å ´æ‰€å (place name)</label>
        {{ form.place_name }}
        <label for="id_date">æ—¥ä»˜ (date)</label>
        {{ form.date }}
        
        <button type="submit" style="margin-top: 1em; background: #fda085; color: #fff; font-weight: bold; border: none; border-radius: 5px; padding: 0.5em 1.5em; cursor: pointer;">äºˆæ¸¬</button>
      </div>
    </form>
  </div>
  {% if form.errors %}
    {{ form.errors }}
  {% endif %}
  {% if error_message %}
  <div style="color: #fff; background-color: #e74c3c; padding: 10px; border-radius: 5px; margin: 10px 0;">
    {{ error_message }}
  </div>
  {% endif %}
  {% if input_info %}
    <div style="margin-top:1em; color: #333;">
      <strong>å…¥åŠ›æƒ…å ±:</strong><br>
      {{ input_info }}
    </div>
  {% endif %}
 
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA79fM6ZX7nEOH2oO4kZIzFa4_LWbW_24Q&libraries=places"></script>
<script>
let map;
let geocoder;
let placesService;
let marker;

function initMap() {
  geocoder = new google.maps.Geocoder();
  // Djangoãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã‹ã‚‰å€¤ã‚’å–å¾—
  var lat = {{ form.lat.value|default:"35.657861" }};
  var lng = {{ form.lon.value|default:"139.343139" }};
  map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: lat, lng: lng },
      zoom: 15,
    });

  placesService = new google.maps.places.PlacesService(map);

  map.addListener("click", (e) => {
    setMarker(e.latLng);
    fillLatLng(e.latLng);

    if (e.placeId) {
      e.stop(); // Googleæ¨™æº–ã®å¹ãå‡ºã—ã‚’æ­¢ã‚ã‚‹
      getPlaceDetail(e.placeId);
    } else {
      // æ–½è¨­ä»¥å¤–ï¼ˆé“è·¯ãƒ»ç©ºãåœ°ãªã©ï¼‰
      reverseGeocode(e.latLng);
      document.getElementById("id_place_name").value = "ï¼ˆæ–½è¨­ãªã—ï¼‰";
    }
  });
}

function setMarker(latLng) {
  if (marker) marker.setMap(null);
  marker = new google.maps.Marker({
    position: latLng,
    map: map,
  });
}

function fillLatLng(latLng) {
  document.getElementById("id_lat").value = latLng.lat().toFixed(6);
  document.getElementById("id_lon").value = latLng.lng().toFixed(6);
}

function getPlaceDetail(placeId) {
  placesService.getDetails(
    { placeId: placeId },
    (place, status) => {
      if (status === google.maps.places.PlacesServiceStatus.OK) {
        document.getElementById("id_place_name").value = place.name;
        document.getElementById("id_address").value = place.formatted_address;
      }
    }
  );
}

function reverseGeocode(latLng) {
  geocoder.geocode({ location: latLng }, (results, status) => {
    if (status === "OK" && results[0]) {
      document.getElementById("id_address").value =
        results[0].formatted_address;
    }
  });
}

initMap();
</script>

</body>
</html>
